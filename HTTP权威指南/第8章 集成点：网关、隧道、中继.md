# 第8章 集成点：网关、隧道、中继

## 网关

在 **HTTP** 和**其他协议及应用程序**之间起到接口作用的统称为**网关**。（顺便回顾一下，在两侧都使用 HTTP 的叫**代理**）

网关可以用<客户端协议>/<服务器端协议>来描述，因此可以划分为：

- **服务器端网关：HTTP/\***，比如 HTTP/FTP 就是个服务端网关，会通过 HTTP 与客户端对话，然后把 HTTP 请求转换为 FTP 协议的请求；而 HTTP/HTTPS 是服务器端安全网关，会对客户端输入的 HTTP 请求进行加密再发给服务端。
- **客户端网关: \*/HTTP**，比如 HTTPS/HTTP 是客户端安全加速网关，会接收客户端的安全的 HTTPS 流量，解密后向服务器发送普通的 HTTP 请求。

在 HTTP 和其他协议之间接口的被称为**协议网关**。此外还有一种在 HTTP 和应用程序之间连接的网关被称为**资源网关**。资源网关本质上是 **HTTP/应用程序**，因此也属于服务器端网关。

资源网关收到请求后会把请求通过 API 发给服务器上的应用程序，这种 API 形成了一个重要的互联网技术，叫 **CGI，即通用网关接口。**

## 隧道：

HTTP 隧道可以通过 HTTP 应用程序访问使用非 HTTP 协议的应用程序，允许用户在 HTTP 连接上发送非 HTTP 流量的隧道。

它使用了HTTP/1.1 的 CONNECT 方法建立隧道。建立过程是：

1. 客户端发一条 CONNECT 请求给隧道网关

CONNECT <domain>:<port> HTTP/1.0

1. 隧道网关打开一条 TCP 连接
2. 服务端建立 TCP 连接
3. 网关发送一条 HTTP 200 响应通知客户端

HTTP/1.0 200 Connection Established

1. 隧道连接建立成功，客户端通过 HTTP 隧道发送的所有数据会直接转发给 TCP 连接，服务器发送的所有数据都会通过 HTTP 隧道转发给客户端

隧道的最大的作用就是**传输加密的 SSL 流量**。因为很多组织都会在客户端和服务器之间加上过滤路由器和防火墙来保证安全性，而 SSL 流量由于信息是加密的，就无法通过代理转发。因此 HTTP 增加了个隧道功能，使得可以将原始的加密数据放在 HTTP 报文重，通过普通的 HTTP 信道传送。有这个机制后，就无需在代理层实现 SSL 了。

但是隧道会引发安全性问题，因为可能会有人在HTTP隧道中使用恶意的协议， 所以网关可以对客户端使用隧道的权利进行认证，而且应该只为特定的端口（比如HTTPS 端口 443）打开隧道。

## 中继：

HTTP 中继是一种没有完全遵循 HTTP 规范的简单 HTTP 代理， 它负责处理 HTTP 中建立连接的部分，然后对字节进行盲转发。

中继的作用主要就是扩展传输距离，或者提供简单的过滤、诊断和内容转换功能。但是由于中继不支持 Connection 首部，所以当客户端发送的 Connection: Keep-Alive 请求后，会导致挂起问题（因为中继转发完一次请求后，就会等待连接关闭，并不知道需要持久连接，从而忽略了客户端的下一条请求）。