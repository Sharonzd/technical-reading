# 第17章 内容协商与转码

# 《HTTP 权威指南》第17章 内容协商与转码

理想状况下，服务器需要根据用户的不同而发送不同的资源版本，比如不同的语言、不同设备样式的文档等。
这种动态内容变换称为**转码**。而这个变换是通过客户端和服务端进行**内容协商**的结果。

## 内容协商

从不同的驱动方来分类的话，有三种内容协商技术

### 客户端驱动协商：

客户端发起请求，服务器发送可选项列表，客户端选择。

**实现方式举例：**
方式1： 服务器返回一个带各种版本链接和描述信息的文档，然后用户决定进哪个页面
方式2：服务器返回 300 Multiple Choices 相应，然后浏览器弹窗让用户选择。

总结：这种方式虽然实现起来最简单，但是需要多一次额外的请求（请求列表），而且也需要为每个版本都分配一个 URL，URL 的传播也是个问题，所以很少使用。

### 服务器驱动协商：

服务器检查客户端的请求首部（包括Accept 之类的内容协商首部集，以及浏览器信息相关的比如 User-Agent 首部），然后决定提供哪个版本的页面。

内容协商首部集包含（以下几个首部的作用都在前两章介绍过了）

- Accept
- Accept-Language
- Accept-Charset
- Accept-Encoding

在首部中可以携带质量值 q （0.0 ~ 1.0）表示优先级。

举例：`Accept-Language: en;q=0.5, fr;q=0.0; nl;1=1.0, tr;q=0.0`

> 注意：", "表示不同首部值的分隔，";"表示不同参数的分隔。该例子表示，最想要荷兰语(nl), 其次是英语(en)，不想要收到法语(fr) 和 土耳其语(tr)。
协商优先级和顺序没关，只跟 q 的值有关

### 透明协商：

由某个中间设备，比如缓存代理来代表客户端进行请求协商。HTTP1.1 定义了 **Vary** 首部，用来告诉中间节点需要使用哪些请求首部进行内容协商。

假如服务器返回的内容并不是根据Accept 首部集决定的，而是一些其他的首部比如 User-Agent 或 Cookie。那代理应该学习服务器的判断决策，这样就可以用同样的、正确的逻辑决策方式来响应客户端。所以服务器就会通过 Vary 来告诉代理它用到了哪些首部。

举例：
---客户端发送：`User-agent: multimedia browser`

- 服务端响应：`Vary: User-agent`
代理缓存了这份响应文档，并且记住了要 User-agent 为 `multimedia browser`的请求才可以使用这份缓存

那下次

- 客户端发送：`User-agent: wireless device`
代理发现 User-agent 不符合它之前所缓存的那份文档的要求，就只能再去请求服务器。
- 服务器继续响应，并且也再次带上了 `Vary: User-agent`
代理就把这份响应文档也缓存上了，并且记住了要 User-agent 为 `wireless device`的请求才可以使用这份缓存。
那下次这两种 User-agent 都能命中缓存了。

## 转码

假如服务器没有能满足用户需求的文档，服务器还可以把现有的文档进行**转码**。

有三种类别的转码

- **格式转换**：把数据从一种格式转换成另一种格式，比如降低图片分辨率。
- **信息综合**：从文档中提取关键的信息片段。比如生成门户网站的 web 页面目录。
- **内容注入**：在文档中自动添加内容，比如添加广告 或者 用户追踪信息。