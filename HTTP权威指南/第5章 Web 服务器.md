# 第5章 Web 服务器

今天介绍 Web 服务器

Web 服务器实现了 HTTP 和相关的 TCP 连接处理，它有三种形式。

1. 可以在标准计算机系统上安装并且运行的通用 Web 服务器软件，比如像 Apache。
2. 预置的软硬件解决方案 Web 服务器设备，一般是指装在机架上的计算机。
3. 嵌入式的 Web 服务器，一般是嵌入到像打印机的小型设备中的小型服务器。

Web 服务器的工作流程

1. 建立连接
    1. 复用持久连接
    2. or 处理新连接
        1. 识别客户端的主机名（以用于详细的访问控制和日志记录，但是比较耗费时间）
        2. 通过 ident 协议确认客户端的用户信息（但是由于安全问题在公共网络上一般不可用）
2. 接收请求报文
    1. 解析请求报文
        1. 解析请求行：请求方法、URI、版本号。
        2. 读取以 CRLF 结尾的报文首部
        3. 检测以 CRLF 结尾的用于标识首部结束的空行（也兼容没有的情况）
        4. 读取请求主体
    2. 报文的数据结构：用特定的带指针和长度的数据结构来将报文存储到快速查询表中，方便访问。
    3. 连接的输入/输出处理结构：
        1. 单线程 Web 服务器：简单但低效。
        2. 多进程及多线程 Web 服务器：由于消耗内存或系统资源，需要限制线程/进程的最大数量。
        3. 复用 I/O 的服务器：一个线程/进程对多个连接进行监听，只处理需要处理的连接。
        4. 复用的多线程 I/O 服务器：多个线程/进程分别监听多个连接，充分利用多 CPU，性能最好。
3. 处理请求
4. 访问资源：将 URI 映射为适当的内容，或者映射到内容生成器。
    1. 如果 URI 是个具体文件路径，根据服务器配置的文档根目录找到相应的文件
    2. 如果 URI 是个目录的话，返回该目录的索引文件（比如index.html），或者一个我们常见到的目录索引页，或者返回错误。
    3. 将 URI 映射到按需动态生成内容的程序上去，比如某个网关。
    4. 如果是 SSI（Server Side includes），那么动态解析这个模板。
    5. 如果资源受到了访问控制，则进行相关认证
5. 构建响应
    1. 如果有需要响应的主体内容的话，则根据一些方式确认资源的 MIME 类型，并且构建出响应实体：Content-Type、Content-Length 和实际报文主体。
    2. 如果要重定向的话，则返回重定向响应。（目的是 用于负载均衡，或者增强 URL 信息，或者带上某些用户信息，或者只是为了规范目录名称，比如加上个/）
6. 发送响应：需要注意做好连接管理
7. 记录事务处理日志。