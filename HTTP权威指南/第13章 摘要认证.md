# 第13章 摘要认证

学习打卡 Day46 《HTTP 权威指南》第13章 摘要认证

摘要认证是对基本认证的改善（回顾一下，基本认证由于明文暴露了用户名和密码，所以安全性很弱）。它的本质区别是：不通过网络发送密码，而是发送一个指纹或者摘要。

摘要是**不可逆的单向函数**，也就是说不会向 base64 那样可以反推出原数据。而且为了避免别人截获摘要后用于重放给服务器，摘要认证还要求使用**随机数**。

摘要认证的握手机制：

1. 【质询】服务器产生随机数，通过 WWW-Authenticate 发送域、随机数和算法
2. 【响应】客户端选择算法，计算出密码和其他数据的摘要，并通过 Authorization 发回给服务器
3. 【成功】服务器对摘要进行认证，产生下一个随机数。并通过Authentication-Info 发送

**摘要算法的输入**

1. 单项散列函数 H(d) 和摘要函数 KD(s,d) ，s 表示密码，d 表示数据，摘要函数建议用 MD5 或 MD5:sess，默认算法为 **MD5**
2. 一个包含了安全性的数据块，包括密码，称为 A1
3. 一个包含了请求报文中非保密属性的数据块，称为 A2

对于 MD5，A1  = <user>:<realm>:<password>

对于 MD5-sess，A1 = MD5(<user>:<realm>:<password>):<nonce>:<cnonce>

推荐在 WWW-Authenticate 中使 qop 为 auth，或 auth-int，以保证对随机数计算和对称认证的支持。

**摘要认证的安全风险**

1. 首部篡改：首部可能会被代理篡改，所以需要进行端到端的加密以及对首部进行签名，目前具有保护级别的首部只有 WWW-Authenticate 和 Authorization 。
2. 重放攻击：指从某个 HTTP 事务中窃取认证证书用于另一个事务，避免的方式是为每个事务都使用唯一的随机数，并且设置超时值。
3. 多重认证机制：服务器一般会提供算法选项，供客户端决定使用什么算法，但是客户端有可能选择很弱的认证方式，比如基本认证，就比较危险。解决办法是要求客户端始终使用最强的认证方式。
4. 词典攻击：指恶意用户靠对随机数和密码的才测程序，不断重试。解决办法是使用复杂的密码，并且设置好过期的策略
5. 恶意代理攻击和中间人攻击：恶意的代理会窃听或者删除提供的所有选项，解决办法是配置客户端始终使用可用的认证策略中最强的一种，或者干脆使用 SSL。
6. 选择明文攻击：恶意的代理给客户端提供随机数，并且用生成的密钥来进行密码分析，可以分析或者试出来密码。解决办法是，配置客户端使用可选的 cnounce 指令，而不是单纯使用服务器提供的随机数。同时使用一些强密码，并且设置好过期策略。
7. 存储密码：假如攻击者入侵了服务端存储的密码摘要文件，就能直接使用密码访问某个域下所有文件。解决办法是，密码的摘要也需要好好保护，而且要确保域名在所有域中唯一，这样密码文件被入侵的时候英系那个也只局限在一个特定的域中。

当然，更安全的方式是使用 TLS 和 HTTPS 协议。