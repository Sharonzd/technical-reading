# 第6章 代理

今天介绍代理（上）

**## 介绍**

Web 代理服务器是位于客户端和服务器之间的网络实体，它会接受客户端的请求报文，返回响应报文，也会给真正的服务器发送请求报文，接受响应报文。所以它既扮演者服务器也扮演者客户端，需要遵循 HTTP 客户端和 HTTP 服务器的规则。

大部分代理都是公共代理，用于提供集中管理的服务，比如高速缓存。也有少部分的私有代理，用于扩展浏览器特性，提高性能等。

**## 代理与网关**

代理跟网关的区别是，代理连接的相同协议的应用程序，而网关连接的是不同协议的断点。比如 Web/Email 网关会跟客户端进行 HTTP 通信，但跟 Email 服务器进行 POP 通信。

**## 代理使用场景**

- 限制儿童内容
- 增加一层文档的访问控制，或者审核跟踪机制
- 安全防火墙
- Web 缓存：维护常用文档的副本，按需提供。
- 反向代理：假扮服务器，并且与其他服务器通信，按需定位客户端所请求的内容，从而提高访问慢速 Web 服务器内容的性能，因此也称为服务器加速器。
- 内容路由器：根据流量状况及内容类型将请求导向特定的 Web 服务器。
- 转码器：比如转换图片格式，或者压缩图片，甚至翻译文档等。
- 匿名者：在请求过程中删除身份特征，用于隐私访问。

**## 代理的部署位置**

- 出口代理：部署在本地网络的出口点，控制本地网络和大型因特网之间的流量，用在比如公司网络防火墙和过滤等场景。
    - 客户端 <==本地网络==> 代理 <==因特网==> 服务器
- 访问代理：部署在ISP （互联网服务供应商）的访问点，用于处理用户的聚合请求，常用于缓存场景。
    - 客户端 <==ISP==> 代理 <==因特网==> 服务器
- 反向代理：部署在网络边缘，Web 服务器之前。
    - 客户端 <==因特网==> 代理 <==本地网络==> 服务器
- 网络交换代理：部署在网络交换点，可以用于减轻网络的拥堵，监视流量。
    - 客户端 <==因特网1==> --路由器 -- 代理 -- 路由器 -- <==因特网2==> 服务器

**## 代理的层次关系**

多层代理级联，靠近入口（服务器）的称为父代理，靠近出口（客户端）的称为子代理

- 客户端 <-->代理1（代理2的子代理）<-->代理2 <--> 代理3 <--> 原始服务器

代理可以是动态决定层次关系的，比如子代理根据负载情况选择父代理来实现负载均衡，也可以基于地理位置选择父代理，也可以根据 URI 决定转发到哪个代理或者服务器，也可以针对付费服务转发到大型的高速的缓存服务器。

代理（中）

**## 代理获取流量方式**

- 修改客户端（浏览器），指定代理配置
    - 手工配置：手动指定代理的主机和端口
    - 浏览器预置
    - 代理自动配置（PAC）：配一个 URI，这个 URI 指向一个 JS 编写的配置文件.pac，由客户端读取并运行它。（百度就用了这个）
    - Web 代理自动发现协议（WPAD）：使用一些资源发现技术来自动查找到合适的 PAC 文件并使用。
- 修改网络，由网络基础设施拦截网络流量
- 修改 DNS，使得请求被发到假扮了 Web 服务器名字和 IP 地址的代理。
- 修改 Web 服务器，由服务器将请求重定向到一个代理去

**## 代理的 URI 问题 1**

- 代理 URI 和服务器 URI 不同：服务器 URI 只包含部分路径，但代理 URI 需要有完整 URI。（因为代理需要知道目标服务器是谁，才能建立好连接）
- 类似的问题：虚拟主机 Web 服务器由于共享物理机，所以使用 Host 头部来承载主机和端口信息
- 拦截代理和反向代理，都由于是在客户端不知情的情况下进行的代理。所以客户端发的是部分 URI。

上述问题的解法：

- 对于完整的 URI，代理直接使用完整 URI。
- 对于部分 URI，而且有 Host 的 header，就用 Host 确定原始服务器的名字和端口号。
- 对于部分 URI，而且没有 Host 头部，就用其他方法确定原始服务器
    - 对于反向代理，使用真实服务器的地址和端口号来配置代理
    - 对于流量被拦截的情况，拦截流量的网络基础设施可以提供原始 IP 和端口，就使用这个 IP 和端口号。
    - 无法确认原始服务器的，就返回错误报文

今天介绍代理的最后一些内容

**## 代理的 URI 问题2**

浏览器会自动扩展输入的 URI 中的主机名（baidu => [www.baidu.com](http://www.baidu.com/) ），并且根据 IP 地址连接到一个有效的服务器（如果有多个 IP 的话， 且有 IP 是不可用的话，浏览器会依次的试看哪个 IP 可用）。

但对于有显示的代理时，浏览器会直接把用户 URI 发给代理，不会对不完整的主机名自动扩展。所以这种代理一般会模仿浏览器，实现自动补全。

对于有拦截代理的情况，浏览器不知道有代理，所以会自动扩展主机名，并且会查到 IP 地址的列表。但是当浏览器尝试用第一个 IP连到服务器的时候，因为有拦截代理，所以浏览器还以为成功连接了，直到代理去访问服务器的时候，才发现服务器挂了。这时候代理就傻眼了也没法儿重试了。这种情况下，代理需要实现容错机制，比如可以通过解析 Host 首部的主机名来用类似浏览器的方式查询 IP list 并挨个儿试，也可以用之前的 IP 地址来反向 DNS 查找找到其他 IP 地址。

**## 追踪报文的方式**（用于检测报文流过程中的问题）

Via 首部：Via 首部会列出报文途径的每个节点（代理或网关）的信息。格式为 Via: 1.1 foo.com, 1.0 bar.com

TRACE 方法：客户端发送一个 TRACE 请求后，服务器会把整个请求报文作为响应报文的主体发回给客户端。 此外，Max-Forward 首部可以用来限制最大转发次数，从而可以测试报文是不是在被循环转发。

**## 代理认证**

对于专门用于访问控制的代理服务器，当它收到受限内容的请求时，会返回一个 407 Proxy Authorization Required 状态码。客户端获取证书后重新发送请求，从而完成认证操作。

**## 代理的互操作性**

代理对于不支持的首部和方法，必须转发下去。比如对于 OPTIONS 请求返回的应该是原始服务器所支持的功能，即便代理不理解 服务器响应中 Allow 字段中描述的所有的方法，也不能修改 Allow 字段。